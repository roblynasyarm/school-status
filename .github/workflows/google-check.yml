name: Auto Google Status Check
on:
  push:
    branches: ["main"]
  schedule:
    - cron: '8,23,38,53 * * * *'
  workflow_dispatch:

jobs:
  check-google:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Fetch and Check Google Status
        id: google
        run: |
          # Fetch the raw data
          curl -s "https://www.google.com/appsstatus/dashboard/incidents.json" > raw_google.json
          
          # We search the file for any status that ISN'T 'available' 
          # Google uses 'available', 'disruption', or 'outage'
          # If 'disruption' or 'outage' is found, grep will return a '0' exit code
          if grep -qiE "disruption|outage" raw_google.json; then
            echo "Google reporting issue"
            echo "HAS_ISSUE=true" >> $GITHUB_ENV
          else
            echo "Google clear"
            echo "HAS_ISSUE=false" >> $GITHUB_ENV
          fi

      - name: Update status.json
        run: |
          NOW=$(TZ='Europe/London' date '+%Y-%m-%d %H:%M')
          
          if [ "${{ env.HAS_ISSUE }}" = "true" ]; then
            # Update status.json with 'Down' status and timestamp
            jq --arg now "$NOW" '.services.google = {"status": "Down", "last_updated": $now} | .global_issue = true | .global_last_updated = $now | .message = "Google Workspace: Active Disruption Reported"' status.json > temp.json && mv temp.json status.json
          else
            # Update status.json with 'Up' status and timestamp
            jq --arg now "$NOW" '.services.google = {"status": "Up", "last_updated": $now} | .global_issue = false | .global_last_updated = $now | .message = "All Systems Operational"' status.json > temp.json && mv temp.json status.json
          fi

      - name: Commit Changes
        run: |
          git config --global user.name "Yarm Status Bot"
          git config --global user.email "status@yarmschool.org"
          git add status.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update Google status" && git push)
