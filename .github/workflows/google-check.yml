name: Auto Google Status Check
on:
  push:
    branches: ["main"]
  schedule:
    - cron: '8,23,38,53 * * * *'
  workflow_dispatch:

jobs:
  check-google:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Fetch and Clean Google Status
        id: google
        run: |
          # Fetch the raw data
          curl -s "https://www.google.com/appsstatus/dashboard/incidents.json" > raw_google.json
          
          # Clean the data: Remove the leading 'dashboard.onFullHistory(' and trailing ')'
          # If the file doesn't have the wrapper, this safely does nothing.
          sed 's/^[^({]*//; s/)[^)]*$//' raw_google.json > clean_google.json
          
          # Check for any active incident today
          # This looks for services where occurrence_type is not 'none'
          INCIDENT_COUNT=$(jq '[.[] | select(.occurrence_type != "none")] | length' clean_google.json)
          
          if [ "$INCIDENT_COUNT" -gt "0" ]; then
            echo "HAS_ISSUE=true" >> $GITHUB_ENV
          else
            echo "HAS_ISSUE=false" >> $GITHUB_ENV
          fi

      - name: Update status.json
        run: |
          NOW=$(TZ='Europe/London' date '+%Y-%m-%d %H:%M')
          
          if [ "${{ env.HAS_ISSUE }}" = "true" ]; then
            # Update status.json with 'Down' status and timestamp
            jq --arg now "$NOW" '.services.google = {"status": "Down", "last_updated": $now} | .global_issue = true | .global_last_updated = $now | .message = "Google Workspace: Active Disruption Reported"' status.json > temp.json && mv temp.json status.json
          else
            # Update status.json with 'Up' status and timestamp
            jq --arg now "$NOW" '.services.google = {"status": "Up", "last_updated": $now} | .global_issue = false | .global_last_updated = $now | .message = "All Systems Operational"' status.json > temp.json && mv temp.json status.json
          fi

      - name: Commit Changes
        run: |
          git config --global user.name "Yarm Status Bot"
          git config --global user.email "status@yarmschool.org"
          git add status.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update Google status" && git push)
