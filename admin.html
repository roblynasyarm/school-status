<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console | Yarm Status</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --yarm-blue: rgb(3, 41, 106); --yarm-green: #2ed573; --yarm-red: #ff4757; }
        body { font-family: 'Montserrat', sans-serif; background: #f4f7f9; padding: 20px; color: #333; }
        .card { background: white; padding: 30px; border-radius: 12px; max-width: 700px; margin: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* Service Block Styling */
        .service-block { background: #f9f9f9; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; position: relative; }
        .service-header { display: flex; justify-content: space-between; font-weight: 600; color: var(--yarm-blue); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        label { display: block; margin-top: 10px; font-weight: 600; font-size: 0.75rem; color: #666; text-transform: uppercase; }
        input, select, button { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: white; padding: 10px; border-radius: 6px; border: 1px solid #efefef; }
        
        .btn-push { background: var(--yarm-green); color: white; font-weight: bold; font-size: 1.1rem; margin-top: 25px; border: none; cursor: pointer; padding: 15px; }
        .btn-logout { background: #666; color: white; border: none; padding: 8px 15px; width: auto; font-size: 0.8rem; cursor: pointer; border-radius: 4px; }
        .delete-btn { color: var(--yarm-red); font-size: 0.75rem; cursor: pointer; font-weight: 600; border: none; background: none; width: auto; padding: 0; }
        
        #admin-content { display: none; }
        #log { text-align: center; font-weight: 600; margin-top: 15px; min-height: 1.5em; }
        hr { border: 0; border-top: 1px solid #eee; margin: 25px 0; }
    </style>
</head>
<body>

    <div class="card" id="login-card">
        <h2 style="color: var(--yarm-blue); margin-top:0;">Yarm Admin Login</h2>
        <p style="font-size: 0.9rem; color: #666;">Enter password to manage digital services.</p>
        <input type="password" id="password" placeholder="Enter Password">
        <button onclick="unlock()">Unlock Console</button>
        <p id="login-err" style="color: var(--yarm-red); font-size: 0.8rem; text-align: center; margin-top: 10px;"></p>
    </div>

    <div class="card" id="admin-content">
        <div class="header-flex">
            <h2 style="margin:0; color: var(--yarm-blue);">Management Console</h2>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>

        <label>Global Status Message (Top Banner)</label>
        <input type="text" id="global_message" placeholder="e.g. All Systems Operational">
        
        <label>Global Alert State</label>
        <select id="global_issue">
            <option value="false">‚úÖ Normal (Green Banner)</option>
            <option value="true">‚ö†Ô∏è Incident (Red Banner)</option>
        </select>

        <hr>
        <h3 style="margin-bottom: 15px; font-size: 1rem;">Service Configuration</h3>
        <div id="services-list"></div>

        <div style="background:#eef2f7; padding:20px; border-radius:8px; margin-top:20px;">
            <h4 style="margin:0 0 10px 0; font-size: 0.9rem;">Add New Service</h4>
            <div style="display:flex; gap:10px;">
                <input type="text" id="new_name" placeholder="Name (e.g. iSAMS Portal)" style="margin:0;">
                <button onclick="addService()" style="background:var(--yarm-blue); width:120px; margin:0;">Add Service</button>
            </div>
        </div>

        <button onclick="saveChanges()" class="btn-push">Push All Changes Live</button>
        <p id="log"></p>
    </div>

    <script>
        // REPLACE THIS WITH YOUR AES ENCRYPTED TOKEN STRING
        const ENCRYPTED_TOKEN = "U2FsdGVkX1+oJae4Znfxi+y1Af9zfXuNrQJ8X6mjIY/4H84oK1IvGPsn90PfS3j2V0VWX0FwTDj6Pfh7jmzTFsblkrAlaKQOg/6b1UkyYRxIVXCwW921MTJEPjh4MbIJYmCh5Msj2gEcVGz6JJGQ1A==";
        
        let decryptedToken = "";
        let currentData = {};

        function logout() {
            decryptedToken = "";
            location.reload();
        }

        async function unlock() {
            const pw = document.getElementById('password').value;
            try {
                const bytes = CryptoJS.AES.decrypt(ENCRYPTED_TOKEN, pw);
                decryptedToken = bytes.toString(CryptoJS.enc.Utf8);

                if (!decryptedToken.startsWith("github_pat")) throw new Error("Invalid");

                document.getElementById('login-card').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                loadData();
            } catch (e) {
                document.getElementById('login-err').innerText = "Access Denied. Incorrect Password.";
            }
        }

        async function loadData() {
            const res = await fetch('status.json?t=' + Date.now());
            currentData = await res.json();
            document.getElementById('global_issue').value = currentData.global_issue.toString();
            document.getElementById('global_message').value = currentData.message;
            renderServices();
        }

        function renderServices() {
            const container = document.getElementById('services-list');
            container.innerHTML = "";
            Object.keys(currentData.services).forEach(key => {
                const s = currentData.services[key];
                container.innerHTML += `
                    <div class="service-block">
                        <div class="service-header">
                            <span>${key}</span>
                            <button class="delete-btn" onclick="deleteService('${key}')">REMOVE SERVICE</button>
                        </div>
                        <div class="config-grid">
                            <div>
                                <label>Manual Status</label>
                                <select onchange="updateVal('${key}', 'status', this.value)">
                                    <option value="Up" ${s.status === 'Up' ? 'selected' : ''}>Up (Operational)</option>
                                    <option value="Down" ${s.status === 'Down' ? 'selected' : ''}>Down (Issues)</option>
                                </select>
                            </div>
                            <div>
                                <label>Automation Type</label>
                                <select onchange="updateVal('${key}', 'type', this.value)">
                                    <option value="manual" ${s.type === 'manual' ? 'selected' : ''}>Manual Only</option>
                                    <option value="ping" ${s.type === 'ping' ? 'selected' : ''}>HTTP Ping (200 OK)</option>
                                    <option value="keyword" ${s.type === 'keyword' ? 'selected' : ''}>Keyword Check</option>
                                </select>
                            </div>
                            <div style="grid-column: span 2;">
                                <label>URL to Check</label>
                                <input type="text" value="${s.url || ''}" onchange="updateVal('${key}', 'url', this.value)" placeholder="https://...">
                            </div>
                            <div>
                                <label>Keyword Search</label>
                                <input type="text" value="${s.keyword || ''}" onchange="updateVal('${key}', 'keyword', this.value)" placeholder="e.g. Operational">
                            </div>
                            <div>
                                <label>Keyword Logic</label>
                                <select onchange="updateVal('${key}', 'keyword_logic', this.value)">
                                    <option value="presence" ${s.keyword_logic === 'presence' ? 'selected' : ''}>Pass if FOUND</option>
                                    <option value="absence" ${s.keyword_logic === 'absence' ? 'selected' : ''}>Pass if MISSING</option>
                                </select>
                            </div>
                        </div>
                    </div>`;
            });
        }

        function updateVal(key, field, val) {
            currentData.services[key][field] = val;
            // Update timestamp if status is manually toggled
            if(field === 'status') {
                currentData.services[key].last_updated = new Date().toLocaleString('en-GB', { timeZone: 'Europe/London' }).slice(0, 16);
            }
        }

        function addService() {
            const input = document.getElementById('new_name');
            const name = input.value.trim();
            if(!name) return;
            currentData.services[name] = { 
                status: "Up", 
                type: "manual", 
                url: "", 
                keyword: "", 
                keyword_logic: "presence", 
                last_updated: "Added Now" 
            };
            input.value = "";
            renderServices();
        }

        function deleteService(key) {
            if(confirm(`Are you sure you want to remove ${key}?`)) {
                delete currentData.services[key];
                renderServices();
            }
        }

        async function saveChanges() {
            const log = document.getElementById('log');
            log.style.color = "#666";
            log.innerText = "üîÑ Syncing with GitHub...";

            try {
                // Fetch the freshest SHA
                const repoRes = await fetch('https://api.github.com/repos/roblynasyarm/school-status/contents/status.json', {
                    headers: { 'Authorization': `token ${decryptedToken}` }
                });
                const repoData = await repoRes.json();
                const latestSha = repoData.sha;

                // Prepare Data
                currentData.global_issue = document.getElementById('global_issue').value === "true";
                currentData.message = document.getElementById('global_message').value;
                currentData.global_last_updated = new Date().toLocaleString('en-GB', { timeZone: 'Europe/London' }).slice(0, 16);

                // Push Update
                const response = await fetch('https://api.github.com/repos/roblynasyarm/school-status/contents/status.json', {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${decryptedToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Admin Panel Update",
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(currentData, null, 2)))),
                        sha: latestSha
                    })
                });

                if(response.ok) {
                    log.style.color = "var(--yarm-green)";
                    log.innerText = "‚úÖ Successfully Updated!";
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const err = await response.json();
                    throw new Error(err.message);
                }
            } catch (e) {
                log.style.color = "var(--yarm-red)";
                log.innerText = "‚ùå Error: " + e.message;
            }
        }
    </script>
</body>
</html>
