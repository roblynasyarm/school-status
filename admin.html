<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console | Yarm Status</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --yarm-blue: rgb(3, 41, 106); --yarm-green: #2ed573; --yarm-red: #ff4757; }
        body { font-family: 'Montserrat', sans-serif; background: #f4f7f9; padding: 20px; color: #333; }
        .card { background: white; padding: 30px; border-radius: 12px; max-width: 700px; margin: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .service-block { background: #f9f9f9; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .service-header { display: flex; justify-content: space-between; font-weight: 600; color: var(--yarm-blue); margin-bottom: 10px; text-transform: uppercase; }
        label { display: block; margin-top: 10px; font-weight: 600; font-size: 0.75rem; color: #666; text-transform: uppercase; }
        input, select, button { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: white; padding: 10px; border-radius: 6px; border: 1px solid #efefef; }
        .btn-push { background: var(--yarm-green); color: white; font-weight: bold; font-size: 1.1rem; margin-top: 25px; border: none; cursor: pointer; padding: 15px; }
        .btn-logout { background: #666; color: white; border: none; padding: 8px 15px; width: auto; font-size: 0.8rem; cursor: pointer; border-radius: 4px; }
        .delete-btn { color: var(--yarm-red); font-size: 0.75rem; cursor: pointer; font-weight: 600; border: none; background: none; width: auto; }
        #admin-content { display: none; }
        #log { text-align: center; font-weight: 600; margin-top: 15px; min-height: 1.5em; }
    </style>
</head>
<body>
    <div class="card" id="login-card">
        <h2>Yarm Admin Login</h2>
        <input type="password" id="password" placeholder="Enter Password">
        <button onclick="unlock()">Unlock Console</button>
        <p id="login-err" style="color: var(--yarm-red); text-align: center;"></p>
    </div>

    <div class="card" id="admin-content">
        <div class="header-flex">
            <h2 style="margin:0;">Management Console</h2>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>

        <label>Global Status Message</label>
        <input type="text" id="global_message" oninput="currentData.message = this.value">
        
        <label>Global Alert State</label>
        <select id="global_issue" onchange="currentData.global_issue = (this.value === 'true')">
            <option value="false">‚úÖ Normal</option>
            <option value="true">‚ö†Ô∏è Incident</option>
        </select>

        <hr>
        <div id="services-list"></div>

        <div style="background:#eef2f7; padding:20px; border-radius:8px;">
            <h4>Add New Service</h4>
            <div style="display:flex; gap:10px;">
                <input type="text" id="new_name" placeholder="Service Name">
                <button onclick="addService()" style="background:var(--yarm-blue); width:120px;">Add</button>
            </div>
        </div>

        <button onclick="saveChanges()" class="btn-push">Push All Changes Live</button>
        <p id="log"></p>
    </div>

    <script>
        const ENCRYPTED_TOKEN = "PASTE_YOUR_ENCRYPTED_TOKEN_HERE";
        let decryptedToken = "";
        let currentData = { services: {} };

        async function unlock() {
            const pw = document.getElementById('password').value;
            try {
                const bytes = CryptoJS.AES.decrypt(ENCRYPTED_TOKEN, pw);
                decryptedToken = bytes.toString(CryptoJS.enc.Utf8);
                if (!decryptedToken.startsWith("github_pat")) throw new Error();
                document.getElementById('login-card').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                loadData();
            } catch (e) { document.getElementById('login-err').innerText = "Invalid Password"; }
        }

        async function loadData() {
            try {
                const res = await fetch('status.json?t=' + Date.now());
                const raw = res.ok ? await res.json() : {};
                currentData = {
                    global_issue: raw.global_issue || false,
                    message: raw.message || "",
                    services: raw.services || {},
                    global_last_updated: raw.global_last_updated || ""
                };
                document.getElementById('global_issue').value = currentData.global_issue.toString();
                document.getElementById('global_message').value = currentData.message;
                renderServices();
            } catch (e) { console.error(e); }
        }

        function renderServices() {
            const container = document.getElementById('services-list');
            container.innerHTML = "";
            Object.keys(currentData.services).forEach(key => {
                const s = currentData.services[key];
                container.innerHTML += `
                    <div class="service-block">
                        <div class="service-header"><span>${key}</span><button class="delete-btn" onclick="deleteService('${key}')">REMOVE</button></div>
                        <div class="config-grid">
                            <div><label>Manual Status</label><select onchange="updateVal('${key}', 'status', this.value)"><option value="Up" ${s.status === 'Up' ? 'selected' : ''}>Up</option><option value="Down" ${s.status === 'Down' ? 'selected' : ''}>Down</option></select></div>
                            <div><label>Type</label><select onchange="updateVal('${key}', 'type', this.value)"><option value="manual" ${s.type === 'manual' ? 'selected' : ''}>Manual</option><option value="ping" ${s.type === 'ping' ? 'selected' : ''}>Ping</option><option value="keyword" ${s.type === 'keyword' ? 'selected' : ''}>Keyword</option></select></div>
                            <div style="grid-column: span 2;"><label>URL</label><input type="text" value="${s.url || ''}" oninput="updateVal('${key}', 'url', this.value)"></div>
                            <div><label>Keyword</label><input type="text" value="${s.keyword || ''}" oninput="updateVal('${key}', 'keyword', this.value)"></div>
                            <div><label>Logic</label><select onchange="updateVal('${key}', 'keyword_logic', this.value)"><option value="presence" ${s.keyword_logic === 'presence' ? 'selected' : ''}>FOUND</option><option value="absence" ${s.keyword_logic === 'absence' ? 'selected' : ''}>MISSING</option></select></div>
                        </div>
                    </div>`;
            });
        }

        function updateVal(k, f, v) { currentData.services[k][f] = v; if(f==='status') currentData.services[k].last_updated = new Date().toLocaleString('en-GB').slice(0,16); }
        function addService() { 
            const n = document.getElementById('new_name').value.trim(); 
            if(!n) return; 
            currentData.services[n] = { status: "Up", type: "manual", url: "", keyword: "", keyword_logic: "presence", last_updated: "New" };
            document.getElementById('new_name').value = ""; renderServices(); 
        }
        function deleteService(k) { if(confirm(`Delete ${k}?`)) { delete currentData.services[k]; renderServices(); } }
        function logout() { location.reload(); }

        async function saveChanges() {
            const log = document.getElementById('log'); log.innerText = "üîÑ Saving...";
            try {
                const repoRes = await fetch('https://api.github.com/repos/roblynasyarm/school-status/contents/status.json?t=' + Date.now(), {
                    headers: { 'Authorization': `token ${decryptedToken}` }
                });
                const repoData = await repoRes.json();
                currentData.global_last_updated = new Date().toLocaleString('en-GB').slice(0,16);
                const response = await fetch('https://api.github.com/repos/roblynasyarm/school-status/contents/status.json', {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${decryptedToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: "Admin Update", content: btoa(unescape(encodeURIComponent(JSON.stringify(currentData, null, 2)))), sha: repoData.sha })
                });
                if(response.ok) { log.innerText = "‚úÖ Saved!"; setTimeout(() => location.reload(), 2000); }
            } catch (e) { log.innerText = "‚ùå Error: " + e.message; }
        }
    </script>
</body>
</html>
