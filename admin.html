<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console | Yarm Status</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --yarm-blue: rgb(3, 41, 106); --yarm-green: #2ed573; --yarm-red: #ff4757; --yarm-gold: #ffc107; }
        body { font-family: 'Montserrat', sans-serif; background: #f4f7f9; padding: 20px; color: #333; }
        .card { background: white; padding: 30px; border-radius: 12px; max-width: 750px; margin: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; gap: 10px; }
        .broadcast-box { background: #fff3cd; border: 2px solid #ffeeba; padding: 20px; border-radius: 8px; margin-bottom: 25px; transition: 0.3s; }
        .broadcast-active { border-color: var(--yarm-gold); background: #fff9e6; box-shadow: 0 0 10px rgba(255,193,7,0.2); }
        .service-block { background: #f9f9f9; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .service-header { display: flex; justify-content: space-between; font-weight: 600; color: var(--yarm-blue); margin-bottom: 10px; text-transform: uppercase; }
        label { display: block; margin-top: 10px; font-weight: 600; font-size: 0.75rem; color: #666; text-transform: uppercase; }
        input, select, button, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        textarea { height: 60px; resize: vertical; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: white; padding: 10px; border-radius: 6px; border: 1px solid #efefef; }
        .btn-push { background: var(--yarm-green); color: white; font-weight: bold; font-size: 1.1rem; margin-top: 20px; border: none; cursor: pointer; padding: 15px; }
        .btn-trigger { background: var(--yarm-blue); color: white; border: none; padding: 12px; cursor: pointer; font-weight: 600; margin-top: 10px; }
        .nav-btn { background: #eee; color: #333; border: none; padding: 8px 15px; width: auto; font-size: 0.8rem; cursor: pointer; border-radius: 4px; text-decoration: none; display: inline-block; }
        .btn-logout { background: #666; color: white; }
        .delete-btn { color: var(--yarm-red); font-size: 0.75rem; cursor: pointer; font-weight: 600; border: none; background: none; width: auto; }
        #admin-content { display: none; }
        #log { text-align: center; font-weight: 600; margin-top: 15px; min-height: 1.5em; }
    </style>
</head>
<body>

    <div class="card" id="login-card">
        <h2 style="color: var(--yarm-blue); margin-top: 0;">Yarm Admin Login</h2>
        <input type="password" id="password" placeholder="Enter Password">
        <button onclick="unlock()" style="background: var(--yarm-blue); color: white; border: none; cursor: pointer;">Unlock Console</button>
        <p id="login-err" style="color: var(--yarm-red); text-align: center; margin-top: 10px;"></p>
        <div style="text-align: center; margin-top: 20px;"><a href="index.html" class="nav-btn">‚Üê Back to Status Page</a></div>
    </div>

    <div class="card" id="admin-content">
        <div class="header-flex">
            <h2 style="margin:0; color: var(--yarm-blue); font-size: 1.4rem;">Management</h2>
            <div style="display: flex; gap: 8px;"><a href="index.html" class="nav-btn">View Status</a><button class="nav-btn btn-logout" onclick="logout()">Logout</button></div>
        </div>

        <div class="broadcast-box" id="broadcast-ui">
            <h4 style="margin:0 0 5px 0; color: #856404;">üö® Emergency Broadcast</h4>
            <select id="broadcast_enabled" onchange="syncBroadcastUI()">
                <option value="false">OFF (Normal Mode)</option>
                <option value="true">ON (Active Override)</option>
            </select>
            <label>Broadcast Message</label>
            <textarea id="broadcast_msg" placeholder="Type emergency message here..."></textarea>
        </div>

        <label>Banner State (Normal Mode)</label>
        <select id="global_issue">
            <option value="false">‚úÖ All Systems Operational</option>
            <option value="true">‚ö†Ô∏è Issues Reported</option>
        </select>

        <label>Status Message</label>
        <input type="text" id="global_message">

        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">

        <h3 style="font-size: 1rem; margin-bottom: 10px;">Service Configuration</h3>
        <div id="services-list"></div>

        <div style="background:#eef2f7; padding:15px; border-radius:8px;">
            <h4 style="margin:0 0 10px 0; font-size: 0.85rem;">Add New Service</h4>
            <div style="display:flex; gap:10px;">
                <input type="text" id="new_name" placeholder="Service Name" style="margin:0;">
                <button onclick="addService()" style="background:var(--yarm-blue); color: white; width:80px; margin:0; border: none; cursor: pointer;">Add</button>
            </div>
        </div>

        <button onclick="saveChanges()" class="btn-push">Push Changes Live</button>
        <button onclick="triggerWorkflow()" class="btn-trigger">‚ö° Run Automated Checks Now</button>
        
        <p style="font-size: 0.75rem; color: #c53030; text-align: center; margin-top: 10px; font-weight: 600;">
            ‚ö†Ô∏è Changes may take 60 seconds to appear on the public page.
        </p>
        <p id="log"></p>
    </div>

    <script>
        // REPLACE THIS with your actual encrypted token
        const ENCRYPTED_TOKEN = "U2FsdGVkX1+oJae4Znfxi+y1Af9zfXuNrQJ8X6mjIY/4H84oK1IvGPsn90PfS3j2V0VWX0FwTDj6Pfh7jmzTFsblkrAlaKQOg/6b1UkyYRxIVXCwW921MTJEPjh4MbIJYmCh5Msj2gEcVGz6JJGQ1A==";
        
        let currentData = { services: {} };

        window.onload = () => { if (sessionStorage.getItem('yarm_token')) showAdmin(); };

        async function unlock() {
            const pw = document.getElementById('password').value;
            try {
                const bytes = CryptoJS.AES.decrypt(ENCRYPTED_TOKEN, pw);
                const token = bytes.toString(CryptoJS.enc.Utf8);
                if (!token.startsWith("github_pat")) throw new Error();
                sessionStorage.setItem('yarm_token', token);
                showAdmin();
            } catch (e) { document.getElementById('login-err').innerText = "Access Denied."; }
        }

        function showAdmin() {
            document.getElementById('login-card').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            loadData();
        }

        async function loadData() {
            try {
                const res = await fetch('status.json?t=' + Date.now());
                const raw = res.ok ? await res.json() : {};
                
                // Safety logic: fill defaults
                currentData = {
                    global_issue: raw.global_issue ?? false,
                    message: raw.message || "All Systems Operational",
                    broadcast_enabled: raw.broadcast_enabled ?? false,
                    broadcast_msg: raw.broadcast_msg || "",
                    services: raw.services || {},
                    global_last_updated: raw.global_last_updated || ""
                };

                document.getElementById('global_issue').value = currentData.global_issue.toString();
                document.getElementById('global_message').value = currentData.message;
                document.getElementById('broadcast_enabled').value = currentData.broadcast_enabled.toString();
                document.getElementById('broadcast_msg').value = currentData.broadcast_msg;
                
                syncBroadcastUI();
                renderServices();
            } catch (e) { console.error("Load error:", e); }
        }

        function syncBroadcastUI() {
            const enabled = document.getElementById('broadcast_enabled').value === 'true';
            document.getElementById('broadcast-ui').className = enabled ? "broadcast-box broadcast-active" : "broadcast-box";
        }

        function renderServices() {
            const container = document.getElementById('services-list');
            container.innerHTML = "";
            Object.keys(currentData.services).forEach(key => {
                const s = currentData.services[key];
                container.innerHTML += `
                    <div class="service-block">
                        <div class="service-header"><span>${key}</span><button class="delete-btn" onclick="deleteService('${key}')">REMOVE</button></div>
                        <div class="config-grid">
                            <div><label>Manual Status</label><select id="status_${key}"><option value="Up" ${s.status === 'Up' ? 'selected' : ''}>Up</option><option value="Down" ${s.status === 'Down' ? 'selected' : ''}>Down</option></select></div>
                            <div><label>Check Type</label><select id="type_${key}"><option value="manual" ${s.type === 'manual' ? 'selected' : ''}>Manual</option><option value="ping" ${s.type === 'ping' ? 'selected' : ''}>Ping (URL)</option><option value="keyword" ${s.type === 'keyword' ? 'selected' : ''}>Keyword Search</option></select></div>
                            <div style="grid-column: span 2;"><label>URL</label><input type="text" id="url_${key}" value="${s.url || ''}"></div>
                            <div><label>Keyword</label><input type="text" id="keyword_${key}" value="${s.keyword || ''}"></div>
                            <div><label>Keyword Logic</label><select id="logic_${key}"><option value="presence" ${s.keyword_logic === 'presence' ? 'selected' : ''}>Pass if FOUND</option><option value="absence" ${s.keyword_logic === 'absence' ? 'selected' : ''}>Pass if MISSING</option></select></div>
                        </div>
                    </div>`;
            });
        }

        function addService() {
            const n = document.getElementById('new_name').value.trim();
            if(!n) return;
            currentData.services[n] = { status: "Up", type: "manual", url: "", keyword: "", keyword_logic: "presence", last_updated: "New" };
            document.getElementById('new_name').value = "";
            renderServices();
        }

        function deleteService(k) { if(confirm(`Delete ${k}?`)) { delete currentData.services[k]; renderServices(); } }

        async function saveChanges() {
            const log = document.getElementById('log');
            log.style.color = "#666";
            log.innerText = "‚è≥ Saving to GitHub...";
            const token = sessionStorage.getItem('yarm_token');

            // Collect all UI values back into currentData
            currentData.global_issue = (document.getElementById('global_issue').value === 'true');
            currentData.message = document.getElementById('global_message').value;
            currentData.broadcast_enabled = (document.getElementById('broadcast_enabled').value === 'true');
            currentData.broadcast_msg = document.getElementById('broadcast_msg').value;

            Object.keys(currentData.services).forEach(key => {
                const s = currentData.services[key];
                s.status = document.getElementById(`status_${key}`).value;
                s.type = document.getElementById(`type_${key}`).value;
                s.url = document.getElementById(`url_${key}`).value;
                s.keyword = document.getElementById(`keyword_${key}`).value;
                s.keyword_logic = document.getElementById(`logic_${key}`).value;
            });

            try {
                const repoRes = await fetch(`https://api.github.com/repos/roblynasyarm/school-status/contents/status.json?t=${Date.now()}`, { headers: { 'Authorization': `token ${token}` } });
                const repoData = await repoRes.json();
                
                const response = await fetch('https://api.github.com/repos/roblynasyarm/school-status/contents/status.json', {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Admin Update",
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(currentData, null, 2)))),
                        sha: repoData.sha
                    })
                });

                if(response.ok) {
                    log.style.color = "var(--yarm-green)";
                    log.innerText = "‚úÖ Saved Successfully! UI refreshing...";
                    setTimeout(() => loadData(), 2000);
                }
            } catch (e) { log.innerText = "‚ùå Error: " + e.message; }
        }

        async function triggerWorkflow() {
            const log = document.getElementById('log');
            const token = sessionStorage.getItem('yarm_token');
            log.innerText = "üöÄ Starting checks...";
            try {
                const res = await fetch('https://api.github.com/repos/roblynasyarm/school-status/actions/workflows/school-checks.yml/dispatches', {
                    method: 'POST',
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' },
                    body: JSON.stringify({ ref: 'main' })
                });
                if(res.ok) log.innerText = "‚ö° Success! Automation is running.";
            } catch (e) { log.innerText = "‚ùå Trigger failed."; }
        }

        function logout() { sessionStorage.removeItem('yarm_token'); location.reload(); }
    </script>
</body>
</html>
